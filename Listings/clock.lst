C51 COMPILER V9.60.7.0   CLOCK                                                             11/15/2025 05:58:03 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE CLOCK
OBJECT MODULE PLACED IN .\Objects\clock.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE clock.c ROM(COMPACT) OPTIMIZE(8,SPEED) PRINT(.\Listings\clock.lst) TABS(
                    -2) OBJECT(.\Objects\clock.obj)

line level    source

   1          #include "clock.h"
   2          
   3          // 全局时间变量 - 使用idata(内部RAM间接寻址)
   4          DateTime idata g_datetime = {2025, 11, 14, 17, 42, 0, 0};
   5          bit g_time_changed = 0;
   6          
   7          // 定时器0初始化 (10ms定时)
   8          // 22.1184MHz晶振，12分频，定时器0工作在模式1
   9          // 10ms定时值 = 65536 - (22118400/12/100) = 65536 - 18432 = 47104 = 0xB800
  10          void Clock_Init(void) {
  11   1          TMOD &= 0xF0;  // 清除Timer0设置
  12   1          TMOD |= 0x01;  // Timer0模式1 (16位定时器)
  13   1          
  14   1          TH0 = 0xB8;    // 装载初值
  15   1          TL0 = 0x00;
  16   1          
  17   1          ET0 = 1;       // 使能Timer0中断
  18   1          EA = 1;        // 使能全局中断
  19   1          TR0 = 1;       // 启动Timer0
  20   1      }
  21          
  22          // 时钟更新 (每10ms调用一次)
  23          void Clock_Update(void) {
  24   1          g_datetime.tick_count++;
  25   1          
  26   1          if(g_datetime.tick_count >= 100) {  // 100个tick = 1秒
  27   2              g_datetime.tick_count = 0;
  28   2              DateTime_AddSecond();
  29   2              g_time_changed = 1;
  30   2          }
  31   1      }
  32          
  33          // 闰年判断
  34          unsigned char IsLeapYear(unsigned int year) {
  35   1          return (unsigned char)(((year % 4 == 0) && (year % 100 != 0)) || (year % 400 == 0));
  36   1      }
  37          
  38          // 获取月份天数
  39          unsigned char GetDaysInMonth(unsigned int year, unsigned char month) {
  40   1          unsigned char days_in_month[] = {31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31};
  41   1          
  42   1          if(month == 2 && IsLeapYear(year)) {
  43   2              return 29;
  44   2          }
  45   1          return days_in_month[month - 1];
  46   1      }
  47          
  48          // 增加一秒
  49          void DateTime_AddSecond(void) {
  50   1          g_datetime.second++;
  51   1          if (g_datetime.second < 60)
  52   1              return;
  53   1          g_datetime.second = 0;
  54   1      
C51 COMPILER V9.60.7.0   CLOCK                                                             11/15/2025 05:58:03 PAGE 2   

  55   1          g_datetime.minute++;
  56   1          if (g_datetime.minute < 60)
  57   1              return;
  58   1          g_datetime.minute = 0;
  59   1      
  60   1          g_datetime.hour++;
  61   1          if (g_datetime.hour < 24)
  62   1              return;
  63   1          g_datetime.hour = 0;
  64   1      
  65   1          g_datetime.day++;
  66   1          if (g_datetime.day <= GetDaysInMonth(g_datetime.year, g_datetime.month))
  67   1              return;
  68   1          g_datetime.day = 1;
  69   1      
  70   1          g_datetime.month++;
  71   1          if (g_datetime.month <= 12)
  72   1              return;
  73   1          g_datetime.month = 1;
  74   1          g_datetime.year++;
  75   1      }
  76          
  77          // 设置日期
  78          void DateTime_SetDate(unsigned int year, unsigned char month, unsigned char day) {
  79   1          g_datetime.year = year;
  80   1          g_datetime.month = month;
  81   1          g_datetime.day = day;
  82   1      }
  83          
  84          // 设置时间
  85          void DateTime_SetTime(unsigned char hour, unsigned char minute, unsigned char second) {
  86   1          g_datetime.hour = hour;
  87   1          g_datetime.minute = minute;
  88   1          g_datetime.second = second;
  89   1          g_datetime.tick_count = 0;
  90   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    226    ----
   CONSTANT SIZE    =     12    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      15
   IDATA SIZE       =      8    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
