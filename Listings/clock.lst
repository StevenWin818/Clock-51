C51 COMPILER V9.60.7.0   CLOCK                                                             11/15/2025 01:57:21 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE CLOCK
OBJECT MODULE PLACED IN .\Objects\clock.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE clock.c ROM(COMPACT) OPTIMIZE(8,SPEED) PRINT(.\Listings\clock.lst) TABS(
                    -2) OBJECT(.\Objects\clock.obj)

line level    source

   1          #include "clock.h"
   2          
   3          // 全局时间变量 - 使用idata(内部RAM间接寻址)
   4          DateTime idata g_datetime = {2025, 11, 14, 17, 42, 0, 0};
   5          bit g_time_changed = 0;
   6          
   7          // 定时器0初始化 (10ms定时)
   8          // 22.1184MHz晶振，12分频，定时器0工作在模式1
   9          // 10ms定时值 = 65536 - (22118400/12/100) = 65536 - 18432 = 47104 = 0xB800
  10          void Clock_Init(void) {
  11   1          TMOD &= 0xF0;  // 清除Timer0设置
  12   1          TMOD |= 0x01;  // Timer0模式1 (16位定时器)
  13   1          
  14   1          TH0 = 0xB8;    // 装载初值
  15   1          TL0 = 0x00;
  16   1          
  17   1          ET0 = 1;       // 使能Timer0中断
  18   1          EA = 1;        // 使能全局中断
  19   1          TR0 = 1;       // 启动Timer0
  20   1      }
  21          
  22          // 时钟更新 (每10ms调用一次)
  23          void Clock_Update(void) {
  24   1          g_datetime.tick_count++;
  25   1          
  26   1          if(g_datetime.tick_count >= 100) {  // 100个tick = 1秒
  27   2              g_datetime.tick_count = 0;
  28   2              DateTime_AddSecond();
  29   2              g_time_changed = 1;
  30   2          }
  31   1      }
  32          
  33          // 闰年判断
  34          unsigned char IsLeapYear(unsigned int year) {
  35   1          if(year % 400 == 0) {
  36   2              return 1;
  37   2          } else if(year % 100 == 0) {
  38   2              return 0;
  39   2          } else if(year % 4 == 0) {
  40   2              return 1;
  41   2          }
  42   1          return 0;
  43   1      }
  44          
  45          // 获取月份天数
  46          unsigned char GetDaysInMonth(unsigned int year, unsigned char month) {
  47   1          unsigned char days_in_month[] = {31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31};
  48   1          
  49   1          if(month == 2 && IsLeapYear(year)) {
  50   2              return 29;
  51   2          }
  52   1          return days_in_month[month - 1];
  53   1      }
  54          
C51 COMPILER V9.60.7.0   CLOCK                                                             11/15/2025 01:57:21 PAGE 2   

  55          // 增加一秒
  56          void DateTime_AddSecond(void) {
  57   1          g_datetime.second++;
  58   1          
  59   1          if(g_datetime.second >= 60) {
  60   2              g_datetime.second = 0;
  61   2              g_datetime.minute++;
  62   2              
  63   2              if(g_datetime.minute >= 60) {
  64   3                  g_datetime.minute = 0;
  65   3                  g_datetime.hour++;
  66   3                  
  67   3                  if(g_datetime.hour >= 24) {
  68   4                      g_datetime.hour = 0;
  69   4                      g_datetime.day++;
  70   4                      
  71   4                      if(g_datetime.day > GetDaysInMonth(g_datetime.year, g_datetime.month)) {
  72   5                          g_datetime.day = 1;
  73   5                          g_datetime.month++;
  74   5                          
  75   5                          if(g_datetime.month > 12) {
  76   6                              g_datetime.month = 1;
  77   6                              g_datetime.year++;
  78   6                          }
  79   5                      }
  80   4                  }
  81   3              }
  82   2          }
  83   1      }
  84          
  85          // 设置日期
  86          void DateTime_SetDate(unsigned int year, unsigned char month, unsigned char day) {
  87   1          g_datetime.year = year;
  88   1          g_datetime.month = month;
  89   1          g_datetime.day = day;
  90   1      }
  91          
  92          // 设置时间
  93          void DateTime_SetTime(unsigned char hour, unsigned char minute, unsigned char second) {
  94   1          g_datetime.hour = hour;
  95   1          g_datetime.minute = minute;
  96   1          g_datetime.second = second;
  97   1          g_datetime.tick_count = 0;
  98   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    232    ----
   CONSTANT SIZE    =     12    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      15
   IDATA SIZE       =      8    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
