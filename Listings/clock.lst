C51 COMPILER V9.60.7.0   CLOCK                                                             11/18/2025 19:49:02 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE CLOCK
OBJECT MODULE PLACED IN .\Objects\clock.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE clock.c ROM(COMPACT) OPTIMIZE(8,SPEED) PRINT(.\Listings\clock.lst) TABS(
                    -2) OBJECT(.\Objects\clock.obj)

line level    source

   1          #include "clock.h"
   2          // 全局时间变量 - 使用idata(内部RAM间接寻址)
   3          DateTime idata g_datetime = {2025, 11, 18, 23, 59, 50, 0};
   4          bit g_time_changed = 0;
   5          
   6          // 定时器0初始化 (10ms定时)
   7          // 22.1184MHz晶振，12分频，定时器0工作在模式1
   8          // 10ms定时值 = 65536 - (22118400/12/100) = 65536 - 18432 = 47104 = 0xB800
   9          void Clock_Init(void) {
  10   1          TMOD &= 0xF0;  // 清除Timer0设置
  11   1          TMOD |= 0x01;  // Timer0模式1 (16位定时器)
  12   1          
  13   1          TH0 = 0xB8;    // 装载初值
  14   1          TL0 = 0x00;
  15   1          
  16   1          ET0 = 1;       // 使能Timer0中断
  17   1          EA = 1;        // 使能全局中断
  18   1          TR0 = 1;       // 启动Timer0
  19   1      }
  20          
  21          // 时钟更新 (每10ms调用一次)
  22          void Clock_Update(void) {
  23   1          g_datetime.tick_count++;
  24   1          
  25   1          if(g_datetime.tick_count >= 100) {  // 100个tick = 1秒
  26   2              g_datetime.tick_count = 0;
  27   2              DateTime_AddSecond();
  28   2              g_time_changed = 1;
  29   2          }
  30   1      }
  31          
  32          // 闰年判断
  33          unsigned char IsLeapYear(unsigned int year) {
  34   1          return (unsigned char)(((year % 4 == 0) && (year % 100 != 0)) || (year % 400 == 0));
  35   1      }
  36          
  37          // 获取月份天数
  38          unsigned char GetDaysInMonth(unsigned int year, unsigned char month) {
  39   1          unsigned char days_in_month[] = {31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31};
  40   1          
  41   1          if(month == 2 && IsLeapYear(year)) {
  42   2              return 29;
  43   2          }
  44   1          return days_in_month[month - 1];
  45   1      }
  46          
  47          // 增加一秒
  48          void DateTime_AddSecond(void) {
  49   1          g_datetime.second++;
  50   1          if (g_datetime.second < 60)
  51   1              return;
  52   1          g_datetime.second = 0;
  53   1      
  54   1          g_datetime.minute++;
C51 COMPILER V9.60.7.0   CLOCK                                                             11/18/2025 19:49:02 PAGE 2   

  55   1          if (g_datetime.minute < 60)
  56   1              return;
  57   1          g_datetime.minute = 0;
  58   1      
  59   1          g_datetime.hour++;
  60   1          if (g_datetime.hour < 24)
  61   1              return;
  62   1          g_datetime.hour = 0;
  63   1      
  64   1          g_datetime.day++;
  65   1          if (g_datetime.day <= GetDaysInMonth(g_datetime.year, g_datetime.month))
  66   1              return;
  67   1          g_datetime.day = 1;
  68   1      
  69   1          g_datetime.month++;
  70   1          if (g_datetime.month <= 12)
  71   1              return;
  72   1          g_datetime.month = 1;
  73   1          g_datetime.year++;
  74   1      }
  75          
  76          // 设置日期
  77          void DateTime_SetDate(unsigned int year, unsigned char month, unsigned char day) {
  78   1          g_datetime.year = year;
  79   1          g_datetime.month = month;
  80   1          g_datetime.day = day;
  81   1      }
  82          
  83          // 设置时间
  84          void DateTime_SetTime(unsigned char hour, unsigned char minute, unsigned char second) {
  85   1          g_datetime.hour = hour;
  86   1          g_datetime.minute = minute;
  87   1          g_datetime.second = second;
  88   1          g_datetime.tick_count = 0;
  89   1      }
  90          
  91          // 星期计算：使用 Sakamoto 算法，返回 0=Sunday .. 6=Saturday
  92          unsigned char GetDayOfWeek(unsigned int year, unsigned char month, unsigned char day) {
  93   1          unsigned int y = year;
  94   1          unsigned char m = month;
  95   1          static const unsigned char t[] = {0, 3, 2, 5, 0, 3, 5, 1, 4, 6, 2, 4};
  96   1          if (m < 3) y -= 1;
  97   1          return (unsigned char)((y + y/4 - y/100 + y/400 + t[m-1] + day) % 7);
  98   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    334    ----
   CONSTANT SIZE    =     12    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     12      17
   IDATA SIZE       =      8    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
