C51 COMPILER V9.60.7.0   BUZZER                                                            11/18/2025 19:49:02 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE BUZZER
OBJECT MODULE PLACED IN .\Objects\buzzer.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE buzzer.c ROM(COMPACT) OPTIMIZE(8,SPEED) PRINT(.\Listings\buzzer.lst) TAB
                    -S(2) OBJECT(.\Objects\buzzer.obj)

line level    source

   1           #include "buzzer.h"
   2          #include "clock.h"
   3          
   4          // ===== å…±äº«çŠ¶æ€ï¼šåœ¨ ISR ä¸Žä¸»çº¿ç¨‹ä¹‹é—´ä¼ é€’ï¼Œå»ºè®® volatile =====
   5          volatile bit g_buzzer_active = 0;
   6          // buzzer_data: ä½Ž6ä½ = å‰©ä½™tick(0~63)ï¼Œé«˜6ä½ = last_second(0~59)
   7          static volatile unsigned char buzzer_data = 0;
   8          // å½“ä¸º1æ—¶ï¼Œè¡¨ç¤ºå·²è¯·æ±‚å–æ¶ˆæœ¬æ¬¡æ•´ç‚¹æŠ¥æ—¶ï¼ˆåªå½±å“å½“å‰å³å°†åˆ°æ¥çš„æ•´ç‚¹ï¼‰
   9          volatile bit g_buzzer_suppressed = 0;
  10          // å­˜å‚¨è¦è¢«æŠ‘åˆ¶çš„ç›®æ ‡å°æ—¶ï¼ˆ0-23ï¼‰ï¼Œå½“ç­‰äºŽ0xFFè¡¨ç¤ºæœªè®¾ç½®
  11          static volatile unsigned char suppressed_target_hour = 0xFF;
  12          
  13          // å·¥å…·å®ï¼šå­˜å–ä½Ž/é«˜ 6 ä½
  14          #define BUZZ_REMAINING_GET() (buzzer_data & 0x3F)
  15          #define BUZZ_REMAINING_SET(v) (buzzer_data = (buzzer_data & 0xC0) | ((v) & 0x3F))
  16          #define BUZZ_LASTSEC_GET() ((buzzer_data >> 6) & 0x3F)
  17          #define BUZZ_LASTSEC_SET(sec) (buzzer_data = (buzzer_data & 0x3F) | (((sec) & 0x3F) << 6))
  18          
  19          // ç»Ÿä¸€å¯åŠ¨èœ‚é¸£å™¨ï¼ŒdurationTicks ä»¥ 10ms ä¸ºå•ä½
  20          static void Buzzer_Start(unsigned char durationTicks)
  21          {
  22   1          if (durationTicks == 0)
  23   1              return;
  24   1          BUZZER = BUZZER_ON;
  25   1          g_buzzer_active = 1;
  26   1          BUZZ_REMAINING_SET(durationTicks); // é”å®šæ—¶é•¿ï¼ŒåŽç»­åªé€’å‡ï¼Œä¸çœ‹å½“å‰æ—¶é—´
  27   1      }
  28          
  29          // åˆå§‹åŒ–
  30          void Buzzer_Init(void)
  31          {
  32   1          BUZZER = BUZZER_OFF; // åˆå§‹é™éŸ³
  33   1          g_buzzer_active = 0;
  34   1          buzzer_data = 0x00;     // remaining=0, last_second=0
  35   1          BUZZ_LASTSEC_SET(0x3F); // è®¾æˆæ— æ•ˆç§’ï¼Œé¿å…ä¸Šç”µç«‹å³è§¦å‘
  36   1      }
  37          
  38          // æ¯ 10ms åœ¨å®šæ—¶å™¨ ISR ä¸­è°ƒç”¨ä¸€æ¬¡
  39          void Buzzer_Update(void)
  40          {
  41   1          unsigned char rem;
  42   1      
  43   1          if (!g_buzzer_active)
  44   1              return;
  45   1      
  46   1          rem = BUZZ_REMAINING_GET();
  47   1          if (rem == 0)
  48   1          {
  49   2              // å®¹é”™ï¼šå‰©ä½™ä¸º0ä½†ä» active
  50   2              BUZZER = BUZZER_OFF;
  51   2              g_buzzer_active = 0;
  52   2              return;
  53   2          }
  54   1      
C51 COMPILER V9.60.7.0   BUZZER                                                            11/18/2025 19:49:02 PAGE 2   

  55   1          rem--;
  56   1          BUZZ_REMAINING_SET(rem);
  57   1          if (rem == 0)
  58   1          {
  59   2              BUZZER = BUZZER_OFF;
  60   2              g_buzzer_active = 0;
  61   2          }
  62   1      }
  63          
  64          // é€šç”¨è„‰å†²ï¼ˆticks 10msï¼‰
  65          static void Buzzer_Pulse(unsigned char ticks)
  66          {
  67   1          if (g_datetime.year >= 2000 && g_datetime.year <= 2099 &&
  68   1              g_datetime.month >= 1 && g_datetime.month <= 12)
  69   1          {
  70   2              Buzzer_Start(ticks);
  71   2          }
  72   1      }
  73          
  74          // ç«‹å³åœæ­¢èœ‚é¸£å™¨å½“å‰å‘å£°å¹¶æ¸…é™¤å‰©ä½™æ—¶é•¿
  75          void Buzzer_CancelNow(void)
  76          {
  77   1          BUZZER = BUZZER_OFF;
  78   1          g_buzzer_active = 0;
  79   1          BUZZ_REMAINING_SET(0);
  80   1      }
  81          
  82          // è¯·æ±‚å–æ¶ˆæœ¬æ¬¡å³å°†åˆ°æ¥çš„æ•´ç‚¹æŠ¥æ—¶ï¼ˆæŒ‰ä¸‹ä»»æ„é”®æ—¶è°ƒç”¨ï¼‰
  83          void Buzzer_RequestCancelCurrentTop(void)
  84          {
  85   1          unsigned char target_hour;
  86   1          // å¦‚æžœå½“å‰ä¸º59åˆ†ï¼Œåˆ™ç›®æ ‡å°æ—¶ä¸ºä¸‹ä¸€ä¸ªå°æ—¶
  87   1          if (g_datetime.minute == 59) {
  88   2              target_hour = (g_datetime.hour + 1) % 24;
  89   2          } else {
  90   2              target_hour = g_datetime.hour;
  91   2          }
  92   1          g_buzzer_suppressed = 1;
  93   1          suppressed_target_hour = target_hour;
  94   1          // ç«‹å³åœæ­¢å½“å‰èœ‚é¸£ï¼ˆå¦‚æžœåœ¨çŸ­å“æœŸé—´æŒ‰é”®ï¼Œä¹Ÿåº”åœæ­¢å£°éŸ³ï¼‰
  95   1          Buzzer_CancelNow();
  96   1      }
  97          
  98          // 100ms çŸ­å“ï¼ˆ10 tickï¼‰
  99          void Buzzer_Short(void)
 100          {
 101   1          Buzzer_Pulse(10);
 102   1      }
 103          
 104          // 500ms é•¿å“ï¼ˆ50 tickï¼‰
 105          void Buzzer_Long(void)
 106          {
 107   1          Buzzer_Pulse(50);
 108   1      }
 109          
 110          // æŠ¥æ—¶è§¦å‘é€»è¾‘ï¼š55~59 ç§’çŸ­å“ï¼›0 ç§’é•¿å“
 111          void Buzzer_Check(void)
 112          {
 113   1          unsigned char now_sec = g_datetime.second & 0x3F;
 114   1          unsigned char last_sec = BUZZ_LASTSEC_GET();
 115   1      
 116   1          // ç”¨ last_second é˜²æŠ–ï¼Œç¡®ä¿æ¯ç§’åªè§¦å‘ä¸€æ¬¡
C51 COMPILER V9.60.7.0   BUZZER                                                            11/18/2025 19:49:02 PAGE 3   

 117   1          if (now_sec == last_sec)
 118   1          {
 119   2              return;
 120   2          }
 121   1          BUZZ_LASTSEC_SET(now_sec);
 122   1      
 123   1          // å¦‚æžœå·²è¯·æ±‚å–æ¶ˆæœ¬æ¬¡æ•´ç‚¹æŠ¥æ—¶ï¼Œåˆ™åœ¨è¢«æŠ‘åˆ¶çš„æ—¶æ®µå±è”½çŸ­å“ä¸Žé•¿å“
 124   1          if (g_buzzer_suppressed)
 125   1          {
 126   2              if (suppressed_target_hour == 0xFF)
 127   2              {
 128   3                  // æœªè®¾ç½®ç›®æ ‡å°æ—¶ï¼Œå®‰å…¨æ¸…é™¤æŠ‘åˆ¶
 129   3                  g_buzzer_suppressed = 0;
 130   3              }
 131   2              else
 132   2              {
 133   3                  // ä¿æŒæŠ‘åˆ¶ç›´åˆ°å·²è¶Šè¿‡æ•´ç‚¹ï¼ˆå³ç›®æ ‡å°æ—¶ä¸”ç§’æ•°å·²>0ï¼‰ï¼Œä»¥ç¡®ä¿0ç§’çš„é•¿å
             -“ä¹Ÿè¢«æŠ‘åˆ¶ã€‚
 134   3                  if (g_datetime.hour == suppressed_target_hour && g_datetime.second > 0)
 135   3                  {
 136   4                      // å·²è¿‡æ•´ç‚¹ï¼Œå–æ¶ˆæŠ‘åˆ¶
 137   4                      g_buzzer_suppressed = 0;
 138   4                      suppressed_target_hour = 0xFF;
 139   4                  }
 140   3                  else
 141   3                  {
 142   4                      // ä»åœ¨æŠ‘åˆ¶æœŸï¼Œå±è”½æ‰€æœ‰çŸ­/é•¿å“
 143   4                      return;
 144   4                  }
 145   3              }
 146   2          }
 147   1      
 148   1          // 59åˆ†çš„ 55~59 ç§’çŸ­å“ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼‰
 149   1          if (g_datetime.minute == 59 && now_sec >= 55 && now_sec <= 59)
 150   1          {
 151   2              Buzzer_Short();
 152   2              return;
 153   2          }
 154   1      
 155   1          // æ•´ç‚¹ï¼šç¬¬ 0 ç§’é•¿å“ï¼ˆä»…ä¸€æ¬¡ï¼‰
 156   1          if (g_datetime.minute == 0 && now_sec == 0)
 157   1          {
 158   2              Buzzer_Long();
 159   2              return;
 160   2          }
 161   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    257    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
