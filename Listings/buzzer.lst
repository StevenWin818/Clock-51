C51 COMPILER V9.60.7.0   BUZZER                                                            11/18/2025 22:40:59 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE BUZZER
OBJECT MODULE PLACED IN .\Objects\buzzer.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE buzzer.c ROM(COMPACT) OPTIMIZE(8,SPEED) PRINT(.\Listings\buzzer.lst) TAB
                    -S(2) OBJECT(.\Objects\buzzer.obj)

line level    source

   1           #include "buzzer.h"
   2          #include "clock.h"
   3          
   4          // ===== å…±äº«çŠ¶æ€ï¼šåœ¨ ISR ä¸Žä¸»çº¿ç¨‹ä¹‹é—´ä¼ é€’ï¼Œå»ºè®® volatile =====
   5          
   6          // ===== å…±äº«çŠ¶æ€ï¼šåœ¨ ISR ä¸Žä¸»çº¿ç¨‹ä¹‹é—´ä¼ é€’ï¼Œå»ºè®® volatile =====
   7          volatile bit g_buzzer_active = 0;
   8          // buzzer_data: ä½Ž6ä½ = å‰©ä½™tick(0~63)ï¼Œé«˜6ä½ = last_second(0~59)
   9          static volatile unsigned char buzzer_data = 0;
  10          // å½“ä¸º1æ—¶ï¼Œè¡¨ç¤ºå·²è¯·æ±‚å–æ¶ˆæœ¬æ¬¡æ•´ç‚¹æŠ¥æ—¶ï¼ˆåªå½±å“å½“å‰å³å°†åˆ°æ¥çš„æ•´ç‚¹ï¼‰
  11          volatile bit g_buzzer_suppressed = 0;
  12          // å­˜å‚¨è¦è¢«æŠ‘åˆ¶çš„ç›®æ ‡å°æ—¶ï¼ˆ0-23ï¼‰ï¼Œå½“ç­‰äºŽ0xFFè¡¨ç¤ºæœªè®¾ç½®
  13          static volatile unsigned char suppressed_target_hour = 0xFF;
  14          
  15          // å·¥å…·å®ï¼šå­˜å–ä½Ž/é«˜ 6 ä½
  16          #define BUZZ_REMAINING_GET() (buzzer_data & 0x3F)
  17          #define BUZZ_REMAINING_SET(v) (buzzer_data = (buzzer_data & 0xC0) | ((v) & 0x3F))
  18          #define BUZZ_LASTSEC_GET() ((buzzer_data >> 6) & 0x3F)
  19          #define BUZZ_LASTSEC_SET(sec) (buzzer_data = (buzzer_data & 0x3F) | (((sec) & 0x3F) << 6))
  20          
  21          // ç»Ÿä¸€å¯åŠ¨èœ‚é¸£å™¨ï¼ŒdurationTicks ä»¥ 10ms ä¸ºå•ä½
  22          static void Buzzer_Start(unsigned char durationTicks)
  23          {
  24   1          if (durationTicks == 0)
  25   1              return;
  26   1          BUZZER = BUZZER_ON;
  27   1          g_buzzer_active = 1;
  28   1          BUZZ_REMAINING_SET(durationTicks); // é”å®šæ—¶é•¿ï¼ŒåŽç»­åªé€’å‡ï¼Œä¸çœ‹å½“å‰æ—¶é—´
  29   1      }
  30          
  31          // åˆå§‹åŒ–
  32          void Buzzer_Init(void)
  33          {
  34   1          BUZZER = BUZZER_OFF; // åˆå§‹é™éŸ³
  35   1          g_buzzer_active = 0;
  36   1          buzzer_data = 0x00;     // remaining=0, last_second=0
  37   1          BUZZ_LASTSEC_SET(0x3F); // è®¾æˆæ— æ•ˆç§’ï¼Œé¿å…ä¸Šç”µç«‹å³è§¦å‘
  38   1      }
  39          
  40          // æ¯ 10ms åœ¨å®šæ—¶å™¨ ISR ä¸­è°ƒç”¨ä¸€æ¬¡
  41          void Buzzer_Update(void)
  42          {
  43   1          unsigned char rem;
  44   1      
  45   1          if (!g_buzzer_active)
  46   1              return;
  47   1      
  48   1          rem = BUZZ_REMAINING_GET();
  49   1          if (rem == 0)
  50   1          {
  51   2              // å®¹é”™ï¼šå‰©ä½™ä¸º0ä½†ä» active
  52   2              BUZZER = BUZZER_OFF;
  53   2              g_buzzer_active = 0;
  54   2              return;
C51 COMPILER V9.60.7.0   BUZZER                                                            11/18/2025 22:40:59 PAGE 2   

  55   2          }
  56   1      
  57   1          rem--;
  58   1          BUZZ_REMAINING_SET(rem);
  59   1          if (rem == 0)
  60   1          {
  61   2              BUZZER = BUZZER_OFF;
  62   2              g_buzzer_active = 0;
  63   2          }
  64   1      }
  65          
  66          // é€šç”¨è„‰å†²ï¼ˆticks 10msï¼‰
  67          static void Buzzer_Pulse(unsigned char ticks)
  68          {
  69   1          if (g_datetime.year >= 2000 && g_datetime.year <= 2099 &&
  70   1              g_datetime.month >= 1 && g_datetime.month <= 12)
  71   1          {
  72   2              Buzzer_Start(ticks);
  73   2          }
  74   1      }
  75          
  76          // ç«‹å³åœæ­¢èœ‚é¸£å™¨å½“å‰å‘å£°å¹¶æ¸…é™¤å‰©ä½™æ—¶é•¿
  77          void Buzzer_CancelNow(void)
  78          {
  79   1          BUZZER = BUZZER_OFF;
  80   1          g_buzzer_active = 0;
  81   1          BUZZ_REMAINING_SET(0);
  82   1      }
  83          
  84          // è¯·æ±‚å–æ¶ˆæœ¬æ¬¡å³å°†åˆ°æ¥çš„æ•´ç‚¹æŠ¥æ—¶ï¼ˆæŒ‰ä¸‹ä»»æ„é”®æ—¶è°ƒç”¨ï¼‰
  85          void Buzzer_RequestCancelCurrentTop(void)
  86          {
  87   1          unsigned char target_hour;
  88   1          // å¦‚æžœå½“å‰ä¸º59åˆ†ï¼Œåˆ™ç›®æ ‡å°æ—¶ä¸ºä¸‹ä¸€ä¸ªå°æ—¶
  89   1          if (g_datetime.minute == 59) {
  90   2              target_hour = (g_datetime.hour + 1) % 24;
  91   2          } else {
  92   2              target_hour = g_datetime.hour;
  93   2          }
  94   1          g_buzzer_suppressed = 1;
  95   1          suppressed_target_hour = target_hour;
  96   1          // ç«‹å³åœæ­¢å½“å‰èœ‚é¸£ï¼ˆå¦‚æžœåœ¨çŸ­å“æœŸé—´æŒ‰é”®ï¼Œä¹Ÿåº”åœæ­¢å£°éŸ³ï¼‰
  97   1          Buzzer_CancelNow();
  98   1      }
  99          
 100          // æŠ¥æ—¶è§¦å‘é€»è¾‘ï¼š55~59 ç§’çŸ­å“ï¼›0 ç§’é•¿å“
 101          void Buzzer_Check(void)
 102          {
 103   1          unsigned char now_sec = g_datetime.second & 0x3F;
 104   1          unsigned char last_sec = BUZZ_LASTSEC_GET();
 105   1      
 106   1          // ç”¨ last_second é˜²æŠ–ï¼Œç¡®ä¿æ¯ç§’åªè§¦å‘ä¸€æ¬¡
 107   1          if (now_sec == last_sec)
 108   1          {
 109   2              return;
 110   2          }
 111   1          BUZZ_LASTSEC_SET(now_sec);
 112   1      
 113   1          // å¦‚æžœå·²è¯·æ±‚å–æ¶ˆæœ¬æ¬¡æ•´ç‚¹æŠ¥æ—¶ï¼Œåˆ™åœ¨è¢«æŠ‘åˆ¶çš„æ—¶æ®µå±è”½çŸ­å“ä¸Žé•¿å“
 114   1          if (g_buzzer_suppressed)
 115   1          {
 116   2              if (suppressed_target_hour == 0xFF)
C51 COMPILER V9.60.7.0   BUZZER                                                            11/18/2025 22:40:59 PAGE 3   

 117   2              {
 118   3                  // æœªè®¾ç½®ç›®æ ‡å°æ—¶ï¼Œå®‰å…¨æ¸…é™¤æŠ‘åˆ¶
 119   3                  g_buzzer_suppressed = 0;
 120   3              }
 121   2              else
 122   2              {
 123   3                  // ä¿æŒæŠ‘åˆ¶ç›´åˆ°å·²è¶Šè¿‡æ•´ç‚¹ï¼ˆå³ç›®æ ‡å°æ—¶ä¸”ç§’æ•°å·²>0ï¼‰ï¼Œä»¥ç¡®ä¿0ç§’çš„é•¿å
             -“ä¹Ÿè¢«æŠ‘åˆ¶ã€‚
 124   3                  if (g_datetime.hour == suppressed_target_hour && g_datetime.second > 0)
 125   3                  {
 126   4                      // å·²è¿‡æ•´ç‚¹ï¼Œå–æ¶ˆæŠ‘åˆ¶
 127   4                      g_buzzer_suppressed = 0;
 128   4                      suppressed_target_hour = 0xFF;
 129   4                  }
 130   3                  else
 131   3                  {
 132   4                      // ä»åœ¨æŠ‘åˆ¶æœŸï¼Œå±è”½æ‰€æœ‰çŸ­/é•¿å“
 133   4                      return;
 134   4                  }
 135   3              }
 136   2          }
 137   1      
 138   1          // 59åˆ†çš„ 55~59 ç§’çŸ­å“ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼‰
 139   1          if (g_datetime.minute == 59 && now_sec >= 55 && now_sec <= 59)
 140   1          {
 141   2              Buzzer_Pulse(8);
 142   2              return;
 143   2          }
 144   1      
 145   1          // æ•´ç‚¹ï¼šç¬¬ 0 ç§’é•¿å“ï¼ˆä»…ä¸€æ¬¡ï¼‰
 146   1          if (g_datetime.minute == 0 && now_sec == 0)
 147   1          {
 148   2              Buzzer_Pulse(50);
 149   2              return;
 150   2          }
 151   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    250    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
