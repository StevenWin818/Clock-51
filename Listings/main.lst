C51 COMPILER V9.60.7.0   MAIN                                                              11/15/2025 22:57:08 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c ROM(COMPACT) OPTIMIZE(8,SPEED) PRINT(.\Listings\main.lst) TABS(2)
                    - OBJECT(.\Objects\main.obj)

line level    source

   1          #include <reg51.h>
   2          #include "lcd_ks0108.h"
   3          #include "font.h"
   4          #include "clock.h"
   5          #include "key.h"
   6          #include "stopwatch.h"
   7          #include "display.h"
   8          #include "buzzer.h"
   9          #include "state.h"
  10          
  11          // 全局变量
  12          unsigned char data g_system_state = STATE_HOME;
  13          unsigned char data g_menu_pos = 0;     // 菜单位置: 0=日期, 1=时间, 2=秒表
  14          unsigned char data g_edit_pos = 0;     // 编辑位置: 用于逐位编辑
  15          unsigned char data g_refresh_counter = 0;
  16          
  17          // 光标超时相关变量
  18          unsigned int data g_menu_cursor_timeout = 0; // 菜单光标超时计数（单位：10ms）
  19          bit g_menu_cursor_visible = 1;               // 菜单光标是否显示
  20          
  21          // 临时设定变量
  22          unsigned int data g_temp_year;
  23          unsigned char data g_temp_month;
  24          unsigned char data g_temp_day;
  25          unsigned char data g_temp_hour;
  26          unsigned char data g_temp_minute;
  27          unsigned char data g_temp_second;
  28          
  29          static void TempTime_Tick(void) {
  30   1          g_temp_second++;
  31   1          if(g_temp_second >= 60) {
  32   2              g_temp_second = 0;
  33   2              g_temp_minute++;
  34   2              if(g_temp_minute >= 60) {
  35   3                  g_temp_minute = 0;
  36   3                  g_temp_hour++;
  37   3                  if(g_temp_hour >= 24) {
  38   4                      g_temp_hour = 0;
  39   4                  }
  40   3              }
  41   2          }
  42   1      }
  43          
  44          // 定时器0中断服务程序 (合并所有10ms任务)
  45          void Timer0_ISR(void) interrupt 1 {
  46   1          TH0 = 0xB8;    // 重新装载初值（22.1184MHz）
  47   1          TL0 = 0x00;
  48   1          
  49   1          // 时钟更新
  50   1          Clock_Update();
  51   1          
  52   1          // 秒表更新
  53   1          Stopwatch_Update();
  54   1          
C51 COMPILER V9.60.7.0   MAIN                                                              11/15/2025 22:57:08 PAGE 2   

  55   1          // 按键扫描
  56   1          Key_Scan();
  57   1          
  58   1          // 蜂鸣器更新
  59   1          Buzzer_Update();
  60   1          
  61   1          // 刷新计数
  62   1          g_refresh_counter++;
  63   1      }
  64          
  65          // 处理主页按键
  66          void Handle_HomePage_Keys(unsigned char key) {
  67   1          if(key == KEY_VAL_4) {
  68   2              // 进入菜单选择模式
  69   2              g_system_state = STATE_MENU;
  70   2              g_menu_pos = 0;
  71   2              Display_HomePage();
  72   2          }
  73   1      }
  74          
  75          // 处理菜单选择按键
  76          void Handle_Menu_Keys(unsigned char key) {
  77   1          if(key == KEY_VAL_4) {
  78   2              // 切换菜单项
  79   2              g_menu_pos++;
  80   2              if(g_menu_pos > 2) g_menu_pos = 0;
  81   2              Display_HomePage();
  82   2          } else if(key == KEY_VAL_1) {
  83   2              // 确认进入选中的功能
  84   2              if(g_menu_pos == 0) {
  85   3                  // 进入日期设定
  86   3                  g_system_state = STATE_DATE_SET;
  87   3                  g_temp_year = g_datetime.year;
  88   3                  g_temp_month = g_datetime.month;
  89   3                  g_temp_day = g_datetime.day;
  90   3                  g_edit_pos = 0;  // 从第一位开始编辑
  91   3                  Display_HomePage();
  92   3              } else if(g_menu_pos == 1) {
  93   3                  // 进入时间设定
  94   3                  g_system_state = STATE_TIME_SET;
  95   3                  g_temp_hour = g_datetime.hour;
  96   3                  g_temp_minute = g_datetime.minute;
  97   3                  g_temp_second = g_datetime.second;
  98   3                  g_edit_pos = 0;  // 从第一位开始编辑
  99   3                  Display_HomePage();
 100   3              } else if(g_menu_pos == 2) {
 101   3                  // 进入秒表
 102   3                  g_system_state = STATE_STOPWATCH;
 103   3                  Display_ResetStopwatch();
 104   3                  Display_StopwatchPage();
 105   3              }
 106   2          }
 107   1      }
 108          
 109          // 处理日期设定按键 - 逐位编辑模式
 110          // edit_pos: 0-7 对应 YYYY-MM-DD 的8位数字（从右到左）
 111          //           7654 32 10
 112          void Handle_DateSet_Keys(unsigned char key) {
 113   1          unsigned char day_tens, day_ones, month_tens, month_ones;
 114   1          unsigned int year_digit;
 115   1          
 116   1          if(key == (KEY_VAL_1 | 0x10)) {
C51 COMPILER V9.60.7.0   MAIN                                                              11/15/2025 22:57:08 PAGE 3   

 117   2              DateTime_SetDate(g_temp_year, g_temp_month, g_temp_day);
 118   2              g_system_state = STATE_HOME;
 119   2              g_edit_pos = 0;
 120   2              Display_HomePage();
 121   2              return;
 122   2          }
 123   1      
 124   1          if(key == KEY_VAL_1) {
 125   2              // KEY1: 切换到下一位编辑
 126   2              if(g_edit_pos >= 7) {
 127   3                  // 最后一位确认后保存并返回主页
 128   3                  DateTime_SetDate(g_temp_year, g_temp_month, g_temp_day);
 129   3                  g_system_state = STATE_HOME;
 130   3                  g_edit_pos = 0;
 131   3                  Display_HomePage();
 132   3              } else {
 133   3                  g_edit_pos++;
 134   3                  Display_HomePage();
 135   3              }
 136   2          } else if(key == KEY_VAL_2) {
 137   2              // KEY2: 当前位+1
 138   2              if(g_edit_pos == 0) {
 139   3                  // 日的个位
 140   3                  day_tens = g_temp_day / 10;
 141   3                  day_ones = g_temp_day % 10;
 142   3                  day_ones++;
 143   3                  if(day_ones > 9) day_ones = 0;
 144   3                  g_temp_day = day_tens * 10 + day_ones;
 145   3                  if(g_temp_day > GetDaysInMonth(g_temp_year, g_temp_month) || g_temp_day == 0)
 146   3                      g_temp_day = 1;
 147   3              } else if(g_edit_pos == 1) {
 148   3                  // 日的十位
 149   3                  day_ones = g_temp_day % 10;
 150   3                  day_tens = g_temp_day / 10;
 151   3                  day_tens++;
 152   3                  if(day_tens > 3) day_tens = 0;
 153   3                  g_temp_day = day_tens * 10 + day_ones;
 154   3                  if(g_temp_day > GetDaysInMonth(g_temp_year, g_temp_month) || g_temp_day == 0)
 155   3                      g_temp_day = 1;
 156   3              } else if(g_edit_pos == 2) {
 157   3                  // 月的个位
 158   3                  month_tens = g_temp_month / 10;
 159   3                  month_ones = g_temp_month % 10;
 160   3                  month_ones++;
 161   3                  if(month_ones > 9) month_ones = 0;
 162   3                  g_temp_month = month_tens * 10 + month_ones;
 163   3                  if(g_temp_month > 12 || g_temp_month == 0) g_temp_month = 1;
 164   3                  if(g_temp_day > GetDaysInMonth(g_temp_year, g_temp_month))
 165   3                      g_temp_day = GetDaysInMonth(g_temp_year, g_temp_month);
 166   3              } else if(g_edit_pos == 3) {
 167   3                  // 月的十位
 168   3                  month_ones = g_temp_month % 10;
 169   3                  month_tens = g_temp_month / 10;
 170   3                  month_tens++;
 171   3                  if(month_tens > 1) month_tens = 0;
 172   3                  g_temp_month = month_tens * 10 + month_ones;
 173   3                  if(g_temp_month > 12 || g_temp_month == 0) g_temp_month = 1;
 174   3                  if(g_temp_day > GetDaysInMonth(g_temp_year, g_temp_month))
 175   3                      g_temp_day = GetDaysInMonth(g_temp_year, g_temp_month);
 176   3              } else if(g_edit_pos >= 4 && g_edit_pos <= 7) {
 177   3                  // 年份的各位 (个位到千位)
 178   3                  year_digit = 1;
C51 COMPILER V9.60.7.0   MAIN                                                              11/15/2025 22:57:08 PAGE 4   

 179   3                  for(month_ones = 0; month_ones < (g_edit_pos - 4); month_ones++) {
 180   4                      year_digit *= 10;
 181   4                  }
 182   3                  g_temp_year = g_temp_year + year_digit;
 183   3                  if(g_temp_year > 2099) g_temp_year = 2000;
 184   3                  if(g_temp_day > GetDaysInMonth(g_temp_year, g_temp_month))
 185   3                      g_temp_day = GetDaysInMonth(g_temp_year, g_temp_month);
 186   3              }
 187   2              Display_HomePage();
 188   2          } else if(key == KEY_VAL_3) {
 189   2              // KEY3: 当前位-1
 190   2              if(g_edit_pos == 0) {
 191   3                  day_tens = g_temp_day / 10;
 192   3                  day_ones = g_temp_day % 10;
 193   3                  if(day_ones == 0) day_ones = 9;
 194   3                  else day_ones--;
 195   3                  g_temp_day = day_tens * 10 + day_ones;
 196   3                  if(g_temp_day > GetDaysInMonth(g_temp_year, g_temp_month) || g_temp_day == 0)
 197   3                      g_temp_day = GetDaysInMonth(g_temp_year, g_temp_month);
 198   3              } else if(g_edit_pos == 1) {
 199   3                  day_ones = g_temp_day % 10;
 200   3                  day_tens = g_temp_day / 10;
 201   3                  if(day_tens == 0) day_tens = 3;
 202   3                  else day_tens--;
 203   3                  g_temp_day = day_tens * 10 + day_ones;
 204   3                  if(g_temp_day > GetDaysInMonth(g_temp_year, g_temp_month) || g_temp_day == 0)
 205   3                      g_temp_day = GetDaysInMonth(g_temp_year, g_temp_month);
 206   3              } else if(g_edit_pos == 2) {
 207   3                  month_tens = g_temp_month / 10;
 208   3                  month_ones = g_temp_month % 10;
 209   3                  if(month_ones == 0) month_ones = 9;
 210   3                  else month_ones--;
 211   3                  g_temp_month = month_tens * 10 + month_ones;
 212   3                  if(g_temp_month > 12 || g_temp_month == 0) g_temp_month = 12;
 213   3                  if(g_temp_day > GetDaysInMonth(g_temp_year, g_temp_month))
 214   3                      g_temp_day = GetDaysInMonth(g_temp_year, g_temp_month);
 215   3              } else if(g_edit_pos == 3) {
 216   3                  month_ones = g_temp_month % 10;
 217   3                  month_tens = g_temp_month / 10;
 218   3                  if(month_tens == 0) month_tens = 1;
 219   3                  else month_tens--;
 220   3                  g_temp_month = month_tens * 10 + month_ones;
 221   3                  if(g_temp_month > 12 || g_temp_month == 0) g_temp_month = 12;
 222   3                  if(g_temp_day > GetDaysInMonth(g_temp_year, g_temp_month))
 223   3                      g_temp_day = GetDaysInMonth(g_temp_year, g_temp_month);
 224   3              } else if(g_edit_pos >= 4 && g_edit_pos <= 7) {
 225   3                  year_digit = 1;
 226   3                  for(month_ones = 0; month_ones < (g_edit_pos - 4); month_ones++) {
 227   4                      year_digit *= 10;
 228   4                  }
 229   3                  if(g_temp_year < 2000 + year_digit) g_temp_year = 2099;
 230   3                  else g_temp_year = g_temp_year - year_digit;
 231   3                  if(g_temp_day > GetDaysInMonth(g_temp_year, g_temp_month))
 232   3                      g_temp_day = GetDaysInMonth(g_temp_year, g_temp_month);
 233   3              }
 234   2              Display_HomePage();
 235   2          } else if(key == KEY_VAL_4) {
 236   2              // KEY4: 取消并返回主页
 237   2              g_system_state = STATE_HOME;
 238   2              g_edit_pos = 0;
 239   2              g_temp_year = g_datetime.year;
 240   2              g_temp_month = g_datetime.month;
C51 COMPILER V9.60.7.0   MAIN                                                              11/15/2025 22:57:08 PAGE 5   

 241   2              g_temp_day = g_datetime.day;
 242   2              Display_HomePage();
 243   2          }
 244   1      }
 245          
 246          // 处理时间设定按键 - 逐位编辑模式
 247          // edit_pos: 0-5 对应 HH:MM:SS 的6位数字（从右到左）
 248          //           54 32 10
 249          void Handle_TimeSet_Keys(unsigned char key)
 250          {
 251   1          unsigned char tens, ones;
 252   1      
 253   1          if (key == (KEY_VAL_1 | 0x10))
 254   1          {
 255   2              DateTime_SetTime(g_temp_hour, g_temp_minute, g_temp_second);
 256   2              g_system_state = STATE_HOME;
 257   2              g_edit_pos = 0;
 258   2              Display_HomePage();
 259   2              return;
 260   2          }
 261   1      
 262   1          if (key == KEY_VAL_1)
 263   1          {
 264   2              /* * 优化: 这是从 main() 的 switch 中移入的特殊逻辑。
 265   2               * 作用：当编辑 "秒" (pos 0或1) 时，按 "下一位" (KEY_VAL_1)
 266   2               * 会直接跳到 "分钟" (pos 2)。
 267   2               */
 268   2              if (g_edit_pos == 0 || g_edit_pos == 1)
 269   2              {
 270   3                  g_edit_pos = 2; // 跳过秒钟，直接到分钟
 271   3              }
 272   2              else if (g_edit_pos >= 5)
 273   2              {
 274   3                  // 在最后一位（时钟十位）按 "下一位"，则保存并退出
 275   3                  DateTime_SetTime(g_temp_hour, g_temp_minute, g_temp_second);
 276   3                  g_system_state = STATE_HOME;
 277   3                  g_edit_pos = 0;
 278   3              }
 279   2              else
 280   2              {
 281   3                  // 正常情况：编辑位置+1
 282   3                  g_edit_pos++;
 283   3              }
 284   2              Display_HomePage();
 285   2          }
 286   1          else if (key == KEY_VAL_2)
 287   1          {
 288   2              // KEY2: 当前位+1 (逻辑未更改)
 289   2              if (g_edit_pos <= 1)
 290   2              {
 291   3                  g_temp_second = 0;
 292   3                  g_temp_minute++;
 293   3                  if (g_temp_minute >= 60)
 294   3                  {
 295   4                      g_temp_minute = 0;
 296   4                      g_temp_hour++;
 297   4                      if (g_temp_hour >= 24)
 298   4                      {
 299   5                          g_temp_hour = 0;
 300   5                      }
 301   4                  }
 302   3              }
C51 COMPILER V9.60.7.0   MAIN                                                              11/15/2025 22:57:08 PAGE 6   

 303   2              else if (g_edit_pos == 2)
 304   2              {
 305   3                  tens = g_temp_minute / 10;
 306   3                  ones = g_temp_minute % 10;
 307   3                  ones++;
 308   3                  if (ones > 9)
 309   3                      ones = 0;
 310   3                  g_temp_minute = tens * 10 + ones;
 311   3                  if (g_temp_minute >= 60)
 312   3                      g_temp_minute = 0;
 313   3              }
 314   2              else if (g_edit_pos == 3)
 315   2              {
 316   3                  ones = g_temp_minute % 10;
 317   3                  tens = g_temp_minute / 10;
 318   3                  tens++;
 319   3                  if (tens > 5)
 320   3                      tens = 0;
 321   3                  g_temp_minute = tens * 10 + ones;
 322   3              }
 323   2              else if (g_edit_pos == 4)
 324   2              {
 325   3                  tens = g_temp_hour / 10;
 326   3                  ones = g_temp_hour % 10;
 327   3                  ones++;
 328   3                  if (ones > 9)
 329   3                      ones = 0;
 330   3                  g_temp_hour = tens * 10 + ones;
 331   3                  if (g_temp_hour >= 24)
 332   3                      g_temp_hour = 0;
 333   3              }
 334   2              else if (g_edit_pos == 5)
 335   2              {
 336   3                  ones = g_temp_hour % 10;
 337   3                  tens = g_temp_hour / 10;
 338   3                  tens++;
 339   3                  if (tens > 2)
 340   3                      tens = 0;
 341   3                  g_temp_hour = tens * 10 + ones;
 342   3                  if (g_temp_hour >= 24)
 343   3                      g_temp_hour = 0;
 344   3              }
 345   2              Display_HomePage();
 346   2          }
 347   1          else if (key == KEY_VAL_3)
 348   1          {
 349   2              // KEY3: 当前位-1 (逻辑未更改)
 350   2              if (g_edit_pos <= 1)
 351   2              {
 352   3                  g_temp_second = 0;
 353   3              }
 354   2              else if (g_edit_pos == 2)
 355   2              {
 356   3                  tens = g_temp_minute / 10;
 357   3                  ones = g_temp_minute % 10;
 358   3                  if (ones == 0)
 359   3                      ones = 9;
 360   3                  else
 361   3                      ones--;
 362   3                  g_temp_minute = tens * 10 + ones;
 363   3              }
 364   2              else if (g_edit_pos == 3)
C51 COMPILER V9.60.7.0   MAIN                                                              11/15/2025 22:57:08 PAGE 7   

 365   2              {
 366   3                  ones = g_temp_minute % 10;
 367   3                  tens = g_temp_minute / 10;
 368   3                  if (tens == 0)
 369   3                      tens = 5;
 370   3                  else
 371   3                      tens--;
 372   3                  g_temp_minute = tens * 10 + ones;
 373   3              }
 374   2              else if (g_edit_pos == 4)
 375   2              {
 376   3                  tens = g_temp_hour / 10;
 377   3                  ones = g_temp_hour % 10;
 378   3                  if (ones == 0)
 379   3                      ones = 9;
 380   3                  else
 381   3                      ones--;
 382   3                  g_temp_hour = tens * 10 + ones;
 383   3                  if (g_temp_hour >= 24)
 384   3                      g_temp_hour = 23;
 385   3              }
 386   2              else if (g_edit_pos == 5)
 387   2              {
 388   3                  ones = g_temp_hour % 10;
 389   3                  tens = g_temp_hour / 10;
 390   3                  if (tens == 0)
 391   3                      tens = 2;
 392   3                  else
 393   3                      tens--;
 394   3                  g_temp_hour = tens * 10 + ones;
 395   3                  if (g_temp_hour >= 24)
 396   3                      g_temp_hour = 23;
 397   3              }
 398   2              Display_HomePage();
 399   2          }
 400   1          else if (key == KEY_VAL_4)
 401   1          {
 402   2              // KEY4: 取消并返回主页
 403   2              g_system_state = STATE_HOME;
 404   2              g_edit_pos = 0;
 405   2              // （注意：原代码在此处未重置 g_temp_hour 等变量，保持该行为）
 406   2              Display_HomePage();
 407   2          }
 408   1      }
 409          
 410          // 处理秒表按键
 411          void Handle_Stopwatch_Keys(unsigned char key) {
 412   1          if(key == (KEY_VAL_1 | 0x10)) {
 413   2              // 长按确认键：清零
 414   2              Stopwatch_Clear();
 415   2              Display_ResetStopwatch();
 416   2              Display_StopwatchPage();
 417   2          } else if(key == KEY_VAL_1) {
 418   2              // 短按确认键：启动/暂停
 419   2              if(g_stopwatch.state == SW_RUNNING) {
 420   3                  Stopwatch_Pause();
 421   3              } else {
 422   3                  Stopwatch_Start();
 423   3              }
 424   2              Display_StopwatchPage();
 425   2          } else if(key == KEY_VAL_2) {
 426   2              // 增加键：计次
C51 COMPILER V9.60.7.0   MAIN                                                              11/15/2025 22:57:08 PAGE 8   

 427   2              Stopwatch_AddLap();
 428   2              Display_StopwatchPage();
 429   2          } else if(key == KEY_VAL_3) {
 430   2              // 减少键：进入计次查看
 431   2              g_system_state = STATE_LAP_VIEW;
 432   2              g_lap_view_page = 0;
 433   2              Display_LapViewPage();
 434   2          } else if(key == KEY_VAL_4) {
 435   2              // 模式切换：返回主页
 436   2              g_system_state = STATE_HOME;
 437   2              Display_ResetStopwatch();
 438   2              Display_HomePage();
 439   2          }
 440   1      }
 441          
 442          // 处理计次查看按键
 443          void Handle_LapView_Keys(unsigned char key) {
 444   1          if(key == KEY_VAL_2) {
 445   2              // 翻页
 446   2              unsigned char total_pages;
 447   2              g_lap_view_page++;
 448   2              total_pages = (g_lap_count + 3) / 4;
 449   2              if(total_pages == 0) {
 450   3                  total_pages = 1;
 451   3              }
 452   2              if(g_lap_view_page >= total_pages) {
 453   3                  g_lap_view_page = 0;  // 循环
 454   3              }
 455   2              Display_LapViewPage();
 456   2          } else if(key == KEY_VAL_3) {
 457   2              // 返回秒表主界面
 458   2              g_system_state = STATE_STOPWATCH;
 459   2              Display_ResetStopwatch();
 460   2              Display_StopwatchPage();
 461   2          } else if(key == KEY_VAL_4) {
 462   2              // 退出秒表模式
 463   2              g_system_state = STATE_HOME;
 464   2              Display_ResetStopwatch();
 465   2              Display_HomePage();
 466   2          }
 467   1      }
 468          
 469          // 主函数
 470          void main(void) {
 471   1          unsigned char key;
 472   1          unsigned int i;
 473   1          
 474   1          // 初始化LCD
 475   1          LCD_Init();
 476   1          
 477   1          // 等待LCD稳定
 478   1          for(i = 0; i < 10000; i++);
 479   1          
 480   1      
 481   1          Key_Init();
 482   1          Stopwatch_Init();
 483   1          Buzzer_Init();
 484   1          BUZZER = BUZZER_OFF; // 强制关闭蜂鸣器，防止开机误响（使用板级宏）
 485   1          
 486   1          // 显示主页
 487   1          Display_HomePage();
 488   1          
C51 COMPILER V9.60.7.0   MAIN                                                              11/15/2025 22:57:08 PAGE 9   

 489   1          // 最后启动时钟（定时器中断）
 490   1          Clock_Init();
 491   1          
 492   1          // 主循环
 493   1          while(1) {
 494   2              // 获取按键
 495   2              key = Key_GetPressed();
 496   2      
 497   2              // 菜单光标超时处理：有按键且在菜单状态则重置计数和显示
 498   2              if(g_system_state == STATE_MENU) {
 499   3                  if(key) {
 500   4                      g_menu_cursor_timeout = 0;
 501   4                      g_menu_cursor_visible = 1;
 502   4                  } else {
 503   4                      if(g_menu_cursor_visible) {
 504   5                          g_menu_cursor_timeout++;
 505   5                          if(g_menu_cursor_timeout >= 50000) { 
 506   6                              g_menu_cursor_visible = 0;
 507   6                              g_menu_pos = 0;
 508   6                              g_system_state = STATE_HOME; // 超时后直接回主页
 509   6                              Display_HomePage();
 510   6                          }
 511   5                      }
 512   4                  }
 513   3              } else {
 514   3                  g_menu_cursor_visible = 1;
 515   3                  g_menu_cursor_timeout = 0;
 516   3              }
 517   2      
 518   2              switch (g_system_state)
 519   2              {
 520   3              case STATE_TIME_SET:
 521   3                  Handle_TimeSet_Keys(key);
 522   3                  break;
 523   3              case STATE_STOPWATCH:
 524   3                  Handle_Stopwatch_Keys(key);
 525   3                  break;
 526   3              case STATE_LAP_VIEW:
 527   3                  Handle_LapView_Keys(key);
 528   3                  break;
 529   3              case STATE_DATE_SET:
 530   3                  Handle_DateSet_Keys(key);
 531   3                  break;
 532   3              case STATE_MENU:
 533   3                  Handle_Menu_Keys(key);
 534   3                  break;
 535   3              case STATE_HOME:
 536   3              default:
 537   3                  Handle_HomePage_Keys(key);
 538   3                  break;
 539   3              }
 540   2      
 541   2              // 定期刷新显示
 542   2              if (g_time_changed)
 543   2              {
 544   3                  g_time_changed = 0;
 545   3      
 546   3                  // 蜂鸣器检查在每次时间变化时都应执行
 547   3                  Buzzer_Check();
 548   3      
 549   3                  if (g_system_state == STATE_TIME_SET)
 550   3                  {
C51 COMPILER V9.60.7.0   MAIN                                                              11/15/2025 22:57:08 PAGE 10  

 551   4                      // 仅在时间设定界面，临时时间才需要“跳动”
 552   4                      TempTime_Tick();
 553   4                  }
 554   3      
 555   3                  // 在所有显示主页的界面，统一刷新
 556   3                  if (g_system_state == STATE_HOME ||
 557   3                      g_system_state == STATE_MENU ||
 558   3                      g_system_state == STATE_DATE_SET ||
 559   3                      g_system_state == STATE_TIME_SET)
 560   3                  {
 561   4                      Display_HomePage();
 562   4                  }
 563   3              }
 564   2      
 565   2              // 秒表页面的高速刷新 (逻辑未更改)
 566   2              if (g_system_state == STATE_STOPWATCH)
 567   2              {
 568   3                  if (g_refresh_counter >= 2)
 569   3                  { // 20ms刷新一次
 570   4                      g_refresh_counter = 0;
 571   4                      Display_StopwatchPage();
 572   4                  }
 573   3              }
 574   2          }
 575   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2022    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     13      15
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
