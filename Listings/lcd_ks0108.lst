C51 COMPILER V9.60.7.0   LCD_KS0108                                                        11/18/2025 19:49:03 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE LCD_KS0108
OBJECT MODULE PLACED IN .\Objects\lcd_ks0108.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE lcd_ks0108.c ROM(COMPACT) OPTIMIZE(8,SPEED) PRINT(.\Listings\lcd_ks0108.
                    -lst) TABS(2) OBJECT(.\Objects\lcd_ks0108.obj)

line level    source

   1          #include "lcd_ks0108.h"
   2          
   3          // 延迟函数 - 增加延迟时间
   4          void LCD_Delay(void) {
   5   1          unsigned char i;
   6   1          for(i = 0; i < 10; i++);  // 增加到10
   7   1      }
   8          
   9          // helper: 选择左右半屏
  10          static void LCD_Select(unsigned char side) {
  11   1          if (side == 0) {
  12   2              LCD_CS1 = 1;
  13   2              LCD_CS2 = 0;
  14   2          } else {
  15   2              LCD_CS1 = 0;
  16   2              LCD_CS2 = 1;
  17   2          }
  18   1      }
  19          
  20          static void LCD_Deselect(void) {
  21   1          LCD_CS1 = 0;
  22   1          LCD_CS2 = 0;
  23   1      }
  24          
  25          // 检查忙状态
  26          void LCD_CheckBusy(unsigned char side) {
  27   1          unsigned char status;
  28   1          unsigned char timeout = 0;
  29   1          
  30   1          LCD_DATA = 0xFF;
  31   1          LCD_DI = 0;  // 指令
  32   1          LCD_RW = 1;  // 读
  33   1          LCD_Select(side);
  34   1          
  35   1          do {
  36   2              LCD_E = 1;
  37   2              LCD_Delay();
  38   2              status = LCD_DATA;
  39   2              LCD_E = 0;
  40   2              LCD_Delay();
  41   2              timeout++;
  42   2              if(timeout > 200) break;  // 超时退出
  43   2          } while(status & 0x80);  // 检查忙标志
  44   1          
  45   1          LCD_Deselect();
  46   1      }
  47          
  48          // 写命令
  49          void LCD_WriteCmd(unsigned char cmd, unsigned char side) {
  50   1          LCD_CheckBusy(side);
  51   1          LCD_DI = 0;  // 指令
  52   1          LCD_RW = 0;  // 写
  53   1          LCD_Select(side);
  54   1          LCD_DATA = cmd;
C51 COMPILER V9.60.7.0   LCD_KS0108                                                        11/18/2025 19:49:03 PAGE 2   

  55   1          LCD_E = 1;
  56   1          LCD_Delay();
  57   1          LCD_E = 0;
  58   1          LCD_Delay();
  59   1          LCD_Deselect();
  60   1      }
  61          
  62          // 写数据
  63          void LCD_WriteData(unsigned char dat, unsigned char side) {
  64   1          LCD_CheckBusy(side);
  65   1          LCD_DI = 1;  // 数据
  66   1          LCD_RW = 0;  // 写
  67   1          LCD_Select(side);
  68   1          LCD_DATA = dat;
  69   1          LCD_E = 1;
  70   1          LCD_Delay();
  71   1          LCD_E = 0;
  72   1          LCD_Delay();
  73   1          LCD_Deselect();
  74   1      }
  75          
  76          
  77          // LCD初始化
  78          void LCD_Init(void) {
  79   1          unsigned int i;
  80   1          
  81   1          // 复位脉冲 - 严格按照KS0108时序
  82   1          LCD_RST = 0;
  83   1          for(i = 0; i < 5000; i++);  // RST低电平至少1ms
  84   1          LCD_RST = 1;
  85   1          for(i = 0; i < 10000; i++);  // RST释放后等待LCD稳定(至少10ms)
  86   1          
  87   1          // 初始化左右两半屏
  88   1          LCD_WriteCmd(LCD_CMD_DISPLAY_ON, 0);
  89   1          LCD_WriteCmd(LCD_CMD_DISPLAY_ON, 1);
  90   1          LCD_WriteCmd(LCD_CMD_START_LINE | 0, 0);
  91   1          LCD_WriteCmd(LCD_CMD_START_LINE | 0, 1);
  92   1          
  93   1          for(i = 0; i < 1000; i++);  // 额外稳定时间
  94   1          LCD_Clear();
  95   1      }
  96          
  97          // 设置位置
  98          void LCD_SetPos(unsigned char page, unsigned char col) {
  99   1          unsigned char side;
 100   1          
 101   1          if(col < 64) {
 102   2              side = 0;
 103   2          } else {
 104   2              side = 1;
 105   2              col -= 64;
 106   2          }
 107   1          
 108   1          // 确保 page 和 col 在合法范围
 109   1          if(page > 7) page = 7;
 110   1          if(col > 63) col = 63;
 111   1          
 112   1          LCD_WriteCmd(LCD_CMD_SET_X | page, side);
 113   1          LCD_WriteCmd(LCD_CMD_SET_Y | col, side);
 114   1      }
 115          
 116          // 清屏
C51 COMPILER V9.60.7.0   LCD_KS0108                                                        11/18/2025 19:49:03 PAGE 3   

 117          void LCD_Clear(void) {
 118   1          unsigned char page, col;
 119   1          
 120   1          for(page = 0; page < LCD_PAGES; page++) {
 121   2              for(col = 0; col < LCD_WIDTH; col++) {
 122   3                  LCD_DrawByte(page, col, 0x00);
 123   3              }
 124   2          }
 125   1      }
 126          
 127          // 清除指定区域
 128          void LCD_ClearArea(unsigned char page_start, unsigned char page_end, unsigned char col_start, unsigned cha
             -r col_end) {
 129   1          unsigned char page, col;
 130   1          
 131   1          for(page = page_start; page <= page_end; page++) {
 132   2              for(col = col_start; col <= col_end; col++) {
 133   3                  LCD_DrawByte(page, col, 0x00);
 134   3              }
 135   2          }
 136   1      }
 137          
 138          // 在指定位置画一个字节
 139          void LCD_DrawByte(unsigned char page, unsigned char col, unsigned char dat) {
 140   1          LCD_SetPos(page, col);
 141   1          if(col < 64) {
 142   2              LCD_WriteData(dat, 0);
 143   2          } else {
 144   2              LCD_WriteData(dat, 1);
 145   2          }
 146   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    337    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      10
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
