# Clock-51

## AT89C51 系列单片机多功能时钟系统

基于AT89C52单片机的多功能时钟系统，配备128×64 LCD显示屏(KS0108控制器)，实现时钟、秒表、日期时间设定等功能。

## 硬件配置
### LCD显示屏
- **型号**: LGM12641BS1R (128×64像素)
  - P0.5 → RST (复位)

  - P3.0: 确认键
  - P3.1: 增加键
  - P3.2: 减少键
  - P3.3: 模式切换键
- **蜂鸣器**: P2.0

## 功能特性

- 自动闰年处理
- 使用16×16像素字体，清晰易读
- 精度：0.01秒 (百分之一秒)
- 清零：长按确认键 (≥1.5秒)
- 计次：按增加键 (最多20次)
- 查看计次：按减少键进入全屏查看模式
- 秒表主显示使用24×32大字体
- 左上角显示当前时间 (8×16小字)

## 日期时间设定
- 日期设定：年→月→日
- 时间设定：时→分→秒
- 循环调整，自动检查合法性
- 闰年自动识别，月份天数自动调整

## 报时功能
- **整点报时**: 每小时0分0秒长响约0.5秒
- **预报时**: 59分的第55-59秒，每秒短响约0.1秒
- 非阻塞式实现，不影响其他功能

### 报时中断（按键取消）示例

```c
if (key) {
    if ((g_datetime.minute == 59 && g_datetime.second >= 55 && g_datetime.second <= 59) ||
        (g_datetime.minute == 0 && g_datetime.second == 0)) {
        Buzzer_RequestCancelCurrentTop();
    }
}
```

- `Buzzer_RequestCancelCurrentTop()`：请求取消本次（当前小时/预报时）剩余的报时。
- `Buzzer_Check()`：驱动蜂鸣器状态机并处理取消请求。

## 按键交互
- **确认键**: 启动/暂停秒表，确认设置
- **增加键**: 增加数值，计次，翻页
- **减少键**: 减少数值，进入/退出计次查看
- **模式键**: 在不同模式间切换
- 支持长按检测 (1.5秒)
- 消抖处理确保稳定性

## 文件结构

- 计数值 = 22.1184MHz ÷ 12 ÷ 100 = 18432
- 初值 = 65536 - 18432 = 47104 = 0xB800
- TH0 = 0xB8, TL0 = 0x00

├── main.c              # 主程序和状态机
├── lcd_ks0108.h/c     # LCD驱动 (KS0108控制器)
├── font.h/c           # 字库 (8×16, 16×16, 24×32)
├── clock.h/c          # 时钟核心 (定时器0，时间计算)
├── key.h/c            # 按键处理 (扫描，消抖，长按)
├── stopwatch.h/c      # 秒表功能
├── display.h/c        # UI显示层
├── buzzer.h/c         # 蜂鸣器和报时
└── README.md          # 本文件

## 系统状态

程序采用状态机架构，包含以下状态：

1. **STATE_HOME** (主页): 显示日期和时间
2. **STATE_DATE_SET** (日期设定): 调整年月日
3. **STATE_TIME_SET** (时间设定): 调整时分秒
4. **STATE_STOPWATCH** (秒表): 秒表主界面
5. **STATE_LAP_VIEW** (计次查看): 全屏显示计次记录

## 定时系统

### 定时器0配置
- **模式**: 模式1 (16位定时器)
- **定时周期**: 10ms
- **初值计算**: 
10ms定时值 = 65536 - (22118400/12/100) = 65536 - 18432 = 47104 = 0xB800
  - TH0 = 0xB8, TL0 = 0x00

### 中断任务 (每10ms执行)
1. 时钟更新 (100个tick = 1秒)
2. 秒表更新 (百分之一秒精度)
3. 按键扫描 (消抖和长按检测)
4. 蜂鸣器更新 (定时关闭)

## 显示布局

### 主页 (128×64)

```
┌────────────────────────┐
│   2025-11-14          │  Page 0-1 (16px)
│                        │
│   23:59:00            │  Page 3-4 (16px)
│                        │
│  [秒表▶] [设定]      │  Page 6-7 (功能条)
└────────────────────────┘
```

### 秒表页面

```
┌────────────────────────┐
│ 17:42 (当前时间)      │  Page 0-1 (8×16)
│                        │
│    05:23.45           │  Page 2-5 (24×32大字)
│                        │
│ 1:05:23.45            │  Page 6-7 (计次列表)
│ 2:05:24.12            │
└────────────────────────┘
```

## 编译与烧录

### Keil C51设置
1. **Target**: AT89C52
2. **晶振频率**: 22.1184 MHz
3. **输出格式**: HEX
4. **优化级别**: 根据代码大小调整

### 注意事项
- 确保所有源文件都添加到项目中
- 检查P0-P3口的上拉配置
- LCD需要5V供电
- 蜂鸣器可选有源或无源（当前代码适配有源）

## 功能扩展建议

1. **数据存储**: 使用EEPROM保存时间和设置
2. **闹钟功能**: 添加定时提醒
3. **温度显示**: 接入DS18B20温度传感器
4. **电池备份**: RTC芯片保持时间
5. **PWM蜂鸣**: 使用定时器1生成不同音调

## 许可与作者

本项目为教学示例代码，可自由修改和使用。
作者：Steven

## 版本历史

- **v1.0** (2025-11-14): 初始版本
  - 基础时钟功能
  - 秒表与计次
  - 日期时间设定
  - 报时功能

## 开发者备注 (v1.4-fix)

- **修改内容**: 更新了 `Font_16x16`（插入用户提供的 16×16 数字字模并居中），修复了部分数字与冒号的半部对齐问题（针对 '1'、':'、'9'、'6' 等进行了像素级微调）；将主页大字步进从 `12` 改为 `16` 以避免裁切。
- **相关文件**: `font.c`（16×16 字库与 `GetCharIndex` 修复）、`display.c`（大字列步进调整）、`tools/visualize_font.py`（字模离线可视化脚本）、`CHANGELOG.md`（新增 v1.4 修正条目）。
- **编译注意**: 已修复可能触发 Keil C51 C141/C syntax 的数组结尾与存储说明符位置问题。如仍有编译器警告，请先清理工程后重新构建。
- **验证建议**: 在发布前请在目标板上跑一次显示测试（或用 `tools/visualize_font.py` 本地查看 ASCII 预览），若还需微调请提供截图/照片或说明具体字符与位置。
- **提交建议**: 建议的 git 提交信息为 `chore: font and display fixes (v1.4)`.
